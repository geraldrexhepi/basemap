<!DOCTYPE html>
<html>
<head>
  <title>Survey on Digital Agriculture</title>
  <meta charset="utf-8" />
  <style>
    #map {
      height: 80vh;
      width: 100%;
      margin-top: 10px;
    }
    #custom-legend {
      margin-top: 10px;
      margin-left: 0;
      font-family: Calibri;
      font-size: 14px;
      color: #131313;

      background-color: #F0F0F0;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      width: fit-content;
    }
  
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
  
    .legend-line {
      width: 30px;
      height: 4px;
      background: #FCFCFC;
      border-radius: 2px;
    }
    
    .city-legend-point {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #009415;
      background-color: #F0F0F0;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      width: fit-content;
    }
    
    .survey-legend-point {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e74c3c;
    }
    
  </style>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2 style="font-family: Calibri; color: #1b2e00; font-weight: bold;">Digital Agriculture - Survey Locations</h2>

  <p style="font-family: Calibri; color: #1b2e00; font-weight: bold; font-size: 18px;">
    Total Surveys:
    <span id="location-count" style="color: #e74c3c; font-weight: bold; font-size: 18px;">Loading...</span>
  </p>
  
  <div id="custom-legend">
    <div class="legend-item">
      <div class="legend-line" style="background: #333333;"></div>
      <span style="font-family: Calibri; color: #1b2e00; font-weight: bold; font-size: 18px;">
        fastest route to closest city
      </span>
    </div>
  </div>
  
  <div class="legend-item">
    <div class="city-legend-point"></div>
    <span style="font-family: Calibri; color: #1b2e00; font-weight: bold; font-size: 18px;">
      closest city
    </span>
  </div>

  <div class="legend-item">
    <div class="survey-legend-point"></div>
    <span style="font-family: Calibri; color: #1b2e00; font-weight: bold; font-size: 18px;">
    location of interview
    </span>
  </div>

  <p style="font-family: 'Courier New', Courier, monospace; font-weight: bold; color: #1b2e00; font-size: 16px;">
    Last updated:
    <span id="last-updated" style="'Courier New', Courier, monospace; font-weight: bold; color: #007839;">Loading...</span>
  </p>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Excel file URL
    const excelUrl = 'https://raw.githubusercontent.com/geraldrexhepi/basemap/main/locations.xlsx';

    // Function to update last modified date from GitHub API
    async function updateLastModified() {
      try {
        const apiUrl = 'https://api.github.com/repos/geraldrexhepi/basemap/commits?path=locations.xlsx&page=1&per_page=1';
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (Array.isArray(data) && data.length > 0) {
          const commitDate = new Date(data[0].commit.committer.date);
          document.getElementById('last-updated').textContent = commitDate.toLocaleString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
          });
        } else {
          document.getElementById('last-updated').textContent = 'Unavailable';
        }
      } catch (err) {
        console.error('GitHub API error:', err);
        document.getElementById('last-updated').textContent = 'Error';
      }
    }

    // Call last-updated function
    updateLastModified();

    // Initialize Leaflet map
    var map = L.map('map').setView([41.188200, 19.818670], 8);

    // Add base map layer
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    })
    
    baseLayer.setOpacity(0.5);
      
    baseLayer.addTo(map);

    // Function to load generic GeoJSON layer with polygon/line style
    function loadGeoJSONLayer(url, styleOptions) {
      fetch(url)
        .then(response => response.json())
        .then(data => {
          L.geoJSON(data, {
            style: styleOptions,
            onEachFeature: function (feature, layer) {
              if (feature.properties) {
                let popupContent = '';
                for (const key in feature.properties) {
                  popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
                }
                layer.bindPopup(popupContent);
              }
            }
          }).addTo(map);
        })
        .catch(error => {
          console.error("Failed to load GeoJSON:", error);
        });
    }

    //Load fastest.geojson FIRST (below others)
    loadGeoJSONLayer('https://raw.githubusercontent.com/geraldrexhepi/basemap/main/fastest.geojson', {
      color: '#333333', weight: 1.0, opacity: 0.6, fillColor: '#333333', fillOpacity: 0.6
    });

    //Load Excel (survey) data AFTER (above fastest.geojson)
    fetch(excelUrl)
      .then(response => response.arrayBuffer())
      .then(arrayBuffer => {
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        const validLocations = jsonData.filter(row =>
          !isNaN(parseFloat(row.Latitude)) && !isNaN(parseFloat(row.Longitude))
        );

        // Display count
        document.getElementById('location-count').textContent = validLocations.length;

        // Plot survey markers
        validLocations.forEach(row => {
          const lat = parseFloat(row.Latitude);
          const lon = parseFloat(row.Longitude);
          const name = row.key || "Unnamed Point";

          L.circleMarker([lat, lon], {
            radius: 2.0,
            fillColor: '#e74c3c',
            fillOpacity: 1,
            color: null,
            weight: 0
          })
          .addTo(map)
          .bindPopup(`<b>Key: ${name}</b><br>Lat: ${lat}, Lon: ${lon}`);
        });
      })
      .catch(err => {
        console.error("Failed to load Excel file:", err);
        alert("Could not load location data.");
      });

    //Load city.geojson AFTER (above fastest.geojson)
    fetch('https://raw.githubusercontent.com/geraldrexhepi/basemap/main/city.geojson')
      .then(response => response.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 3.3,
              color: '#009415',
              opacity: 1.0,
              fillColor: '#009415',
              fillOpacity: 1.0,
              weight: 0
            });
          },
          onEachFeature: function (feature, layer) {
            if (feature.properties) {
              let popupContent = '';
              for (const key in feature.properties) {
                popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
              }
              layer.bindPopup(popupContent);
            }
          }
        }).addTo(map);
      })
      .catch(error => {
        console.error("Failed to load city.geojson:", error);
      });
    
  </script>
</body>
</html>









